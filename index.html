<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Alpine Bay</title>

  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <!-- Base styles (structure only) -->
  <link rel="stylesheet" href="base.css">
  
  <!-- Theme stylesheet (loaded dynamically) -->
  <link rel="stylesheet" href="theme-aero.css" id="theme-stylesheet">

  <style>
    /* Theme switcher dropdown styles */
    .theme-switcher {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .theme-dropdown {
      position: relative;
    }

    .theme-select {
      padding: 10px 35px 10px 16px;
      border-radius: 20px;
      border: 1px solid rgba(120,180,240,0.4);
      background: 
        linear-gradient(180deg, 
          rgba(40,80,140,0.9) 0%,
          rgba(25,55,100,0.95) 100%);
      color: #e8f4ff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      appearance: none;
      backdrop-filter: blur(15px);
      box-shadow: 
        0 4px 20px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.2);
      transition: all 0.2s;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .theme-select:hover {
      background: 
        linear-gradient(180deg, 
          rgba(50,95,160,0.95) 0%,
          rgba(30,65,120,1) 100%);
      border-color: rgba(140,200,255,0.6);
      box-shadow: 
        0 4px 24px rgba(0,0,0,0.6),
        0 0 20px rgba(74,158,255,0.3),
        inset 0 1px 0 rgba(255,255,255,0.25);
    }

    .theme-select:focus {
      outline: none;
      border-color: rgba(140,200,255,0.7);
      box-shadow: 
        0 4px 24px rgba(0,0,0,0.6),
        0 0 25px rgba(74,158,255,0.5),
        inset 0 1px 0 rgba(255,255,255,0.25);
    }

    .theme-select option {
      background: #0a1a30;
      color: #e8f4ff;
      padding: 10px;
    }

    /* Custom arrow */
    .theme-dropdown::after {
      content: '▼';
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #a8d4ff;
      font-size: 10px;
    }
  </style>
</head>

<body>

<!-- Theme Switcher -->
<div class="theme-switcher">
  <div class="theme-dropdown">
    <select class="theme-select" id="themeSelect">
      <option value="aero">Aero (Heavy)</option>
      <option value="flat">Flat (Light)</option>
    </select>
  </div>
</div>

<header>
  <div class="header-inner">
    <div class="title">The Alpine Bay</div>
  </div>
</header>

<div class="container">
  <div class="controls">
    <input type="text" id="search" placeholder="Search games..." />
    <div class="sort-toggle">
      <label>
        <input type="checkbox" id="groupToggle">
        <span class="toggle-ui"></span>
        <span class="toggle-text">Group by series</span>
      </label>
    </div>
  </div>
  <div id="games"></div>
</div>

<script>
// Theme Switcher
(function() {
  const themeStylesheet = document.getElementById('theme-stylesheet');
  const themeSelect = document.getElementById('themeSelect');
  
  // Load saved theme or default to 'aero'
  const savedTheme = localStorage.getItem('alpine-theme') || 'aero';
  loadTheme(savedTheme);
  themeSelect.value = savedTheme;
  
  themeSelect.addEventListener('change', (e) => {
    const theme = e.target.value;
    loadTheme(theme);
    localStorage.setItem('alpine-theme', theme);
  });
  
  function loadTheme(theme) {
    themeStylesheet.href = `theme-${theme}.css`;
  }
})();

// Games functionality
(function(){
  const container = document.getElementById('games');
  const search = document.getElementById('search');
  const toggle = document.getElementById('groupToggle');
  let dataCache = [];
  
  function showMessage(msg){
    container.innerHTML = `<div class="no-results">${msg}</div>`;
  }

  function seriesKey(name){
    let clean = name
      .replace(/\b(edition|remastered|definitive|collection|hd|remake|redux|complete|ultimate|deluxe|premium|gold|black|limited|presents|airborne|all\s*dlc)\b/gi, '')
      .replace(/\([^)]*\)/g, '')
      .replace(/\s+(v?\d+(\.\d+)?[a-z]?|20\d{2}|\d{4})$/gi, '')
      .replace(/[:\-—–]/g, ' ')
      .trim()
      .toLowerCase();
    
    clean = clean
      .replace(/\s+\b(i{1,3}|iv|v|vi{1,3}|ix|x|xi{1,3})\b.*$/i, '')
      .replace(/\s+\d+(\.\d+)?[a-z]?\b.*$/i, '');
    
    const words = clean.split(/\s+/);
    if (words.length > 2) {
      const lastWord = words[words.length - 1];
      const commonSubtitles = ['prostreet', 'underground', 'payback', 'heat', 'rivals', 'carbon', 
                               'undercover', 'shift', 'run', 'unbound', 'adrenaline', 'airborne',
                               'brotherhood', 'revelations', 'origins', 'odyssey', 'valhalla', 
                               'mirage', 'syndicate', 'unity', 'rogue', 'ghosts', 'vanguard',
                               'warzone', 'infinite', 'warfare', 'cold', 'war', 'blackflag',
                               'revengeance', 'rising', 'unleashed', 'apex', 'delta', 'chronicles',
                               'trilogy', 'spec', 'competizione', 'evo', 'sa', 'iv', 'v',
                               'concept', 'hd'];
      
      if (commonSubtitles.includes(lastWord)) {
        words.pop();
        clean = words.join(' ');
      }
    }
    
    const finalWords = clean.split(/\s+/);
    if (finalWords.length > 3) {
      clean = finalWords.slice(0, Math.min(3, finalWords.length)).join(' ');
    }
    
    return clean.trim() || 'other';
  }

  function render(list){
    container.innerHTML = '';
    if(!list.length){
      showMessage('No games found.');
      return;
    }
    if(!toggle.checked){
      list.forEach(game => renderGame(game, container));
      return;
    }
    const groups = {};
    list.forEach(g=>{
      const k = seriesKey(g.name);
      (groups[k] = groups[k] || []).push(g);
    });
    const sortedSeries = Object.keys(groups).sort();
    sortedSeries.forEach(seriesName=>{
      renderSeriesCard(seriesName, groups[seriesName], container);
    });
  }

  function renderSeriesCard(seriesName, games, parent){
    const card = document.createElement('div');
    card.className = 'series-card';
    
    const header = document.createElement('div');
    header.className = 'series-card-header';
    
    const title = document.createElement('h3');
    title.className = 'series-card-title';
    title.textContent = seriesName === 'other' ? 'Other Games' : seriesName;
    
    const rightSide = document.createElement('div');
    rightSide.style.display = 'flex';
    rightSide.style.alignItems = 'center';
    rightSide.style.gap = '12px';
    
    const count = document.createElement('span');
    count.className = 'series-card-count';
    count.textContent = `${games.length} game${games.length !== 1 ? 's' : ''}`;
    
    const arrow = document.createElement('span');
    arrow.className = 'series-card-arrow';
    arrow.textContent = '▶';
    
    rightSide.appendChild(count);
    rightSide.appendChild(arrow);
    
    header.appendChild(title);
    header.appendChild(rightSide);
    card.appendChild(header);
    
    const gamesContainer = document.createElement('div');
    gamesContainer.className = 'series-card-games';
    
    games.forEach(game => {
      const gameItem = document.createElement('div');
      gameItem.className = 'game-item';
      
      const gameHeader = document.createElement('div');
      gameHeader.className = 'game-item-header';
      
      const gameTitle = document.createElement('div');
      gameTitle.className = 'game-item-title';
      gameTitle.textContent = game.name;
      
      const gameRight = document.createElement('div');
      gameRight.style.display = 'flex';
      gameRight.style.alignItems = 'center';
      gameRight.style.gap = '10px';
      
      const versionCount = document.createElement('span');
      versionCount.className = 'series-card-count';
      versionCount.style.fontSize = '0.85rem';
      versionCount.style.padding = '4px 10px';
      versionCount.textContent = `${game.versions ? game.versions.length : 0} version${game.versions && game.versions.length !== 1 ? 's' : ''}`;
      
      const gameArrow = document.createElement('span');
      gameArrow.className = 'game-item-arrow';
      gameArrow.textContent = '▶';
      
      gameRight.appendChild(versionCount);
      gameRight.appendChild(gameArrow);
      
      gameHeader.appendChild(gameTitle);
      gameHeader.appendChild(gameRight);
      gameItem.appendChild(gameHeader);
      
      const gameContent = document.createElement('div');
      gameContent.className = 'game-item-content';
      
      if (game.description) {
        const desc = document.createElement('p');
        desc.className = 'game-item-description';
        desc.textContent = game.description;
        gameContent.appendChild(desc);
      }
      
      if (game.versions && game.versions.length) {
        const versionsContainer = document.createElement('div');
        versionsContainer.className = 'versions-container';
        
        game.versions.forEach(v => {
          const ver = document.createElement('div');
          ver.className = 'version';
          
          const platform = document.createElement('strong');
          platform.textContent = v.platform;
          ver.appendChild(platform);
          
          const link = document.createElement('a');
          link.href = v.url;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = 'Download';
          link.addEventListener('click', (e) => {
            e.stopPropagation();
          });
          ver.appendChild(link);
          
          versionsContainer.appendChild(ver);
        });
        
        gameContent.appendChild(versionsContainer);
      }
      
      gameItem.appendChild(gameContent);
      
      gameHeader.addEventListener('click', (e) => {
        e.stopPropagation();
        gameItem.classList.toggle('expanded');
      });
      
      gamesContainer.appendChild(gameItem);
    });
    
    card.appendChild(gamesContainer);
    
    header.addEventListener('click', (e) => {
      e.stopPropagation();
      card.classList.toggle('expanded');
    });
    
    parent.appendChild(card);
  }

  function renderGame(game, parent){
    const gameItem = document.createElement('div');
    gameItem.className = 'game-item';

    const gameHeader = document.createElement('div');
    gameHeader.className = 'game-item-header';

    const gameTitle = document.createElement('div');
    gameTitle.className = 'game-item-title';
    gameTitle.textContent = game.name;

    const gameArrow = document.createElement('span');
    gameArrow.className = 'game-item-arrow';
    gameArrow.textContent = '▶';

    gameHeader.appendChild(gameTitle);
    gameHeader.appendChild(gameArrow);
    gameItem.appendChild(gameHeader);

    const gameContent = document.createElement('div');
    gameContent.className = 'game-item-content';

    if (game.description) {
      const desc = document.createElement('p');
      desc.className = 'game-item-description';
      desc.textContent = game.description;
      gameContent.appendChild(desc);
    }

    if (game.versions && game.versions.length) {
      const versionsContainer = document.createElement('div');
      versionsContainer.className = 'versions-container';

      game.versions.forEach(v => {
        const ver = document.createElement('div');
        ver.className = 'version';

        const platform = document.createElement('strong');
        platform.textContent = v.platform;

        const link = document.createElement('a');
        link.href = v.url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = 'Download';

        link.addEventListener('click', e => e.stopPropagation());

        ver.appendChild(platform);
        ver.appendChild(link);
        versionsContainer.appendChild(ver);
      });

      gameContent.appendChild(versionsContainer);
    }

    gameItem.appendChild(gameContent);

    gameHeader.addEventListener('click', () => {
      gameItem.classList.toggle('expanded');
    });

    parent.appendChild(gameItem);
  }

  function apply(){
    const t = search.value.toLowerCase();
    const filtered = dataCache.filter(g =>
      g.name.toLowerCase().includes(t) ||
      (g.description && g.description.toLowerCase().includes(t)) ||
      (g.versions && g.versions.some(v => 
        v.platform.toLowerCase().includes(t) ||
        (v.tags && v.tags.some(tag => tag.toLowerCase().includes(t)))
      ))
    );
    render(filtered);
  }

  showMessage('Loading games...');

  fetch('games.json')
    .then(r => {
      if (!r.ok) throw new Error('Failed to load');
      return r.json();
    })
    .then(d => {
      dataCache = d;
      apply();
    })
    .catch(() => showMessage('Failed to load games.json'));

  search.addEventListener('input', apply);
  toggle.addEventListener('change', apply);
})();
</script>

</body>
</html>
